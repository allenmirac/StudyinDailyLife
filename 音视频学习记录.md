## 视频封装格式

FLV：Flash ，已经渐渐淘汰了，也是层层包装起来。包含header and body，其中body包括audio、video、script。

TS：分成了三层，TS层、PES层、ES层，ES层是最底层，压缩编码后的音频诗句，PES层是在ES层的基础上加上时间戳等信息，TS层在PES层基础上加上了数据流识别信息和传输信息。PAT、PMT表，分析软件easyice。

header body

MP4：很多个Box，层层包装，box之间是树状结构

## FFmpeg 篇

安装之后可以使用ffmpeg、ffplay、ffprobe这三个工具可以实现视频的相关操作，利用这几个工具的相关参数配置可以在命令行下处理媒体文件，有时可以通过简单的命令实现复杂的处理任务。

解码：实现视频播放。

到底怎么个学习路线

以推流为例，流程：采集音视频 --> 编码 --> 封装 --> 传输/推流（？？使用RTP、RTCP、RTSP协议？）--> 接受/解封装 --> 解码 --> 播放

使用Nginx + rtmp实现了一个推流以及拉流过程

## 学习雷神的博客

### 1. RGB、YUV像素级别的数据的转化以及处理

分离YUV420p像素数据中的Y/U/V三个分量步骤:先读取YUV文件，然后按照YUV的分布特征读取出来并且保存。

关键读取代码如下：

```cpp
for(int i=0;i<num;i++){ 
    fread(pic,1,w*h*3/2,fp);
    //Y
    fwrite(pic,1,w*h,fp1);//w*h
    //U
    fwrite(pic+w*h,1,w*h/4,fp2);//w*h的后1/4
    //V
    fwrite(pic+w*h*5/4,1,w*h/4,fp3);//w*h的5/4的后1/4
}
```

由于我没有找到Y、U、V分量数据保存后的显示软件，就学习并使用了ffmpeg将.y文件转为png之后查看效果。转换过程：

```bash
ffmpeg -s 256x256 -pix_fmt gray -f rawvideo -i output_420_y.y lena_y.png
```

ffmpeg参数解释：

| 参数          | 含义                                          |
| :------------ | --------------------------------------------- |
| -s 256*256    | 指定图像分辨，上述示例中为256*256             |
| -pix_fmt gray | 制定像素格式为单通道的灰度图（gray）          |
| -f rawvideo   | 输入的是裸的原始图像数据，没有文件头（Y/U/V） |
| -i xxx        | 输入文件路径                                  |
| lena_y.png    | 输出文件名字，自动调用PNG编码器保存为PNG图片  |

接下来分别测试了`simplest_yuv420_gray`、`simplest_yuv420_halfy`、`simplest_yuv420_border`、`simplest_yuv420_graybar`、`simplest_yuv420_psnr`这些函数。

1、`simplest_yuv420_border`函数关键代码

```cpp
for(int i=0;i<num;i++){
    fread(pic,1,w*h*3/2,fp);
    //Y
    for(int j=0;j<h;j++){
        for(int k=0;k<w;k++){
            if(k<border||k>(w-border)||j<border||j>(h-border)){
                pic[j*w+k]=255;//修改为白色
                //pic[j*w+k]=0;
            }
        }
    }
    fwrite(pic,1,w*h*3/2,fp1);
}
```

修改w*h周围的border个像素的值，这样就在图片周围加入了白色边框。

2、学习了PSNR，PSNR即峰值信噪比（Peak Signal to Noise Ratio），它是最基本的视频质量评估方法之一，基于图像的像素点，借助均方误差来计算图像失真情况，缺点也很明显，就是不符合人眼的主观感受。还要其他常见的图像质量检测方法如SSIM（**Structural Similarity Index**，**结构相似度**）等，这两篇文章中说的非常详细：[谈谈图像质量量化评估标准](http://zhuanlan.zhihu.com/p/120254892)、[图像质量评估综述](https://zhuanlan.zhihu.com/p/32553977)。

`simplest_yuv420_psnr`函数的关键代码：

```cpp
for(int i=0;i<num;i++){
    fread(pic1,1,w*h,fp1);
    fread(pic2,1,w*h,fp2);

    double mse_sum=0,mse=0,psnr=0;
    for(int j=0;j<w*h;j++){
        mse_sum+=pow((double)(pic1[j]-pic2[j]),2);
        if((pic1[j]-pic2[j]) != 0) {
            printf("pix1[100], %d; pix2[100], %d\n", pic1[j], pic2[j]);
        }
    }
    mse=mse_sum/(w*h);
    psnr=10*log10(255.0*255.0/mse);
    printf("%5.3f\n",psnr);
	//跳过接下来1/2
    fseek(fp1,w*h/2,SEEK_CUR);
    fseek(fp2,w*h/2,SEEK_CUR);
    // //U
    // fwrite(pic+w*h,1,w*h/4,fp2);
    // //V
    // fwrite(pic+w*h*5/4,1,w*h/4,fp3);
    // u和v各占1/4，加起来等于1/2，

}
```



